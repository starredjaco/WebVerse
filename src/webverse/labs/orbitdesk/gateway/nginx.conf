worker_processes  1;

events {
  worker_connections  1024;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout  65;

  # Small hardening
  server_tokens off;

  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # OrbitDesk is meant to force discovery of internal subdomains via SSRF.
  # When a user does Host-header fuzzing from the host, their requests reach
  # nginx via the Docker bridge gateway IP for this lab subnet (10.77.0.1).
  # We deliberately serve the normal public site instead of leaking a 403 from ops.
  map $remote_addr $allow_ops_proxy {
    default 1;
    10.77.0.1 0;
  }

  # Choose where ops.orbitdesk.local traffic should actually go:
  # - From host (10.77.0.1): send to public web app
  # - From internal containers: send to ops app
  map $allow_ops_proxy $ops_proxy_pass {
    0 "http://web_upstream";
    1 "http://ops_upstream";
  }

  # Also normalize the Host header we pass upstream:
  # - If we redirected ops -> web, ensure upstream sees orbitdesk.local
  # - Otherwise keep the original host
  map $allow_ops_proxy $ops_upstream_host {
    0 "orbitdesk.local";
    1 $host;
  }

  upstream web_upstream { server web:8000; }
  upstream portal_upstream { server portal:8000; }
  upstream auth_upstream { server auth:8000; }
  upstream api_upstream { server api:8000; }
  upstream files_upstream { server files:8000; }
  upstream ops_upstream { server ops:8000; }

  server {
    listen 80;
    server_name orbitdesk.local www.orbitdesk.local;

    location / {
      proxy_pass http://web_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
    }
  }

  server {
    listen 80;
    server_name portal.orbitdesk.local;

    location / {
      proxy_pass http://portal_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
    }
  }

  server {
    listen 80;
    server_name auth.orbitdesk.local;

    location / {
      proxy_pass http://auth_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
    }
  }

  server {
    listen 80;
    server_name api.orbitdesk.local;

    location / {
      proxy_pass http://api_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
    }
  }

  server {
    listen 80;
    server_name files.orbitdesk.local;

    location / {
      proxy_pass http://files_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
    }
  }

  server {
    listen 80;
    server_name ops.orbitdesk.local;

    location / {
      # Host-originated Host-header fuzzing should NOT reveal ops behavior.
      # SSRF from inside the docker network will still reach ops normally.
      proxy_pass $ops_proxy_pass;
      proxy_set_header Host $ops_upstream_host;
      proxy_set_header X-Forwarded-Proto $scheme;

      # Ops expects internal-only access; gateway never marks requests internal.
      proxy_set_header X-Real-IP $remote_addr;
    }
  }

  # Simple placeholders (keeps things believable)
  server {
    listen 80;
    server_name status.orbitdesk.local;

    location / {
      add_header Content-Type text/html;
      return 200 '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>OrbitDesk Status</title><style>body{font-family:system-ui;background:#0b0d12;color:#e9ecf1;margin:0}.wrap{max-width:900px;margin:0 auto;padding:28px}.card{background:#111522;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}.ok{color:#22c55e}</style></head><body><div class="wrap"><div class="card"><h1>System Status</h1><p class="ok">All systems operational.</p><p>Last updated: <span id="t"></span></p><script>document.getElementById("t").textContent=new Date().toISOString()</script></div></div></body></html>';
    }
  }

  server {
    listen 80;
    server_name docs.orbitdesk.local;

    location / {
      add_header Content-Type text/html;
      return 200 '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>OrbitDesk Docs</title><style>body{font-family:system-ui;background:#0b0d12;color:#e9ecf1;margin:0}.wrap{max-width:900px;margin:0 auto;padding:28px}.card{background:#111522;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}a{color:#a6adbb}</style></head><body><div class="wrap"><div class="card"><h1>Developer Docs</h1><p>Common topics:</p><ul><li>Getting started</li><li>Working with projects</li><li>Document keys & sharing</li><li>Webhooks & integrations</li></ul><p><a href="http://portal.orbitdesk.local/app">Return to portal</a></p></div></div></body></html>';
    }
  }
}
